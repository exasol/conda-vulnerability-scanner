import contextlib
import os
import sqlite3
import tempfile
from pathlib import Path

from conda_security_scanner.scanner import fetch_cpe_dictionary, get_go_cpe_dictionary_binary


def test_cpe_directory_fetch():
    with get_go_cpe_dictionary_binary() as go_cpe_dictionary:
        with tempfile.TemporaryDirectory() as temp_dir:
            cpe_dictionary_file = fetch_cpe_dictionary(go_cpe_dictionary, Path(temp_dir))
            assert cpe_dictionary_file.is_file() and cpe_dictionary_file.name == "cpe.sqlite3"
            with contextlib.closing(sqlite3.connect(cpe_dictionary_file)) as conn:
                rows = conn.execute("select vendor, product, part from categorized_cpes limit 1;").fetchall()
                assert len(rows) == 1 and len(rows[0]) == 3
