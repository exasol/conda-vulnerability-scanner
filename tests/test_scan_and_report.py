import json
from pathlib import Path

from conda_vulnerability_scanner.scanner import scan_and_report, Severity


def test_scan_and_report_success(tmp_path, test_db_path, test_package_list_path):
    """
    Runs scan_and_report with test db and compares the json report with the expected cves
    """
    output_file = tmp_path / "report.json"
    scan_and_report(test_db_path, output_file, test_package_list_path)
    with output_file.open("r") as f:
        json_report = f.read()
    objs = sorted(json.loads(json_report), key=lambda d: str(d))
    expected = sorted([{'cve': 'CVE-2022-29191', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29192', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29193', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29194', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29195', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29196', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29197', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29198', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29199', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29200', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29201', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-476',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29202', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-400',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29203', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-190',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29204', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29205', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5',
                        'cwe': 'CWE-476,CWE-908', 'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29206', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-476',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29207', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-475',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29208', 'cvss': '7.1', 'cvss2': '3.6', 'cvss3': '7.1', 'cwe': 'CWE-787',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29209', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-843',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29210', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5',
                        'cwe': 'CWE-120,CWE-122', 'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29211', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29212', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29213', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
                       {'cve': 'CVE-2022-29216', 'cvss': '7.8', 'cvss2': '4.6', 'cvss3': '7.8', 'cwe': 'CWE-94',
                        'cpe': 'cpe:/a:google:tensorflow:2.8.0'}]
                      , key=lambda d: str(d))
    assert objs == expected


def test_scan_and_report_ignore_cves(tmp_path, test_db_path, test_package_list_path):
    """
    Runs scan_and_report with test db and a cve ignore list and compares the json report with the expected cves
    """
    output_file = tmp_path / "report.json"
    cve_ignore_file = tmp_path / "cve_ignore_file"
    with open(cve_ignore_file, "w") as f:
        f.writelines(["CVE-2022-29191\n", "CVE-2022-29192\n"])
    scan_and_report(test_db_path, output_file, test_package_list_path, cve_ignore_list_file=cve_ignore_file)
    with output_file.open("r") as f:
        json_report = f.read()
    objs = sorted(json.loads(json_report), key=lambda d: str(d))
    expected = sorted([
        {'cve': 'CVE-2022-29193', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29194', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29195', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29196', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29197', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29198', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29199', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29200', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29201', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-476',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29202', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-400',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29203', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-190',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29204', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29205', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5',
         'cwe': 'CWE-476,CWE-908', 'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29206', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-476',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29207', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20,CWE-475',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29208', 'cvss': '7.1', 'cvss2': '3.6', 'cvss3': '7.1', 'cwe': 'CWE-787',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29209', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-843',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29210', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5',
         'cwe': 'CWE-120,CWE-122', 'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29211', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29212', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29213', 'cvss': '5.5', 'cvss2': '2.1', 'cvss3': '5.5', 'cwe': 'CWE-20',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29216', 'cvss': '7.8', 'cvss2': '4.6', 'cvss3': '7.8', 'cwe': 'CWE-94',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'}]
        , key=lambda d: str(d))
    assert objs == expected


def test_scan_and_report_severity_filter(tmp_path, test_db_path, test_package_list_path):
    """
    Runs scan_and_report with test db and severity filter and compares the json report with the expected cves
    """
    output_file = tmp_path / "report.json"
    scan_and_report(test_db_path, output_file, test_package_list_path, severity_filter=Severity.HIGH)
    with output_file.open("r") as f:
        json_report = f.read()
    objs = sorted(json.loads(json_report), key=lambda d: str(d))
    expected = sorted([
        {'cve': 'CVE-2022-29208', 'cvss': '7.1', 'cvss2': '3.6', 'cvss3': '7.1', 'cwe': 'CWE-787',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'},
        {'cve': 'CVE-2022-29216', 'cvss': '7.8', 'cvss2': '4.6', 'cvss3': '7.8', 'cwe': 'CWE-94',
         'cpe': 'cpe:/a:google:tensorflow:2.8.0'}]
        , key=lambda d: str(d))
    assert objs == expected
