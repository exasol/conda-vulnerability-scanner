import contextlib
import sqlite3

from conda_security_scanner.scanner import fetch_cpe_dictionary, get_go_cpe_dictionary_binary


def test_cpe_dictionary_fetch(tmp_path):
    """
    This test runs the function fetch_cpe_dictionary and
    checks if the sqlite3 database was successfully created and
    contains the table categorized_cpes with at least the columns
    vendor, product, part
    """
    with get_go_cpe_dictionary_binary() as go_cpe_dictionary:
        cpe_dictionary_file = fetch_cpe_dictionary(go_cpe_dictionary, tmp_path)
        assert cpe_dictionary_file.is_file() and cpe_dictionary_file.name == "cpe.sqlite3"
        with contextlib.closing(sqlite3.connect(cpe_dictionary_file)) as conn:
            rows = conn.execute("select vendor, product, part from categorized_cpes limit 1;").fetchall()
            assert len(rows) == 1 and len(rows[0]) == 3
