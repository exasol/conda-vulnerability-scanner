import json
import sqlite3
from pathlib import Path

from conda_security_scanner.scanner import lookup_cpes_for_packages


def test_lookup_cpes_for_packages():
    script_directory = Path(__file__).parent
    with open(script_directory / "resources/mamba_list.json") as f:
        packages = json.load(f)
    sqlite_file = script_directory / "resources/test_db/cpe.sqlite3"
    con = sqlite3.connect(sqlite_file)
    result = lookup_cpes_for_packages(packages[:], con)
    assert result == {('python_software_foundation', 'python', '3.8.13'), ('ruby\\-lang', 'openssl', '1.1.1o'),
                      ('libffi_project', 'libffi', '3.4.2'), ('jenkins', 'requests', '2.28.1'),
                      ('mozilla', 'nss', '3.77'), ('bzip', 'bzip2', '1.0.8'), ('libnsl_project', 'libnsl', '2.0.0'),
                      ('tqdm_project', 'tqdm', '4.64.0'), ('gnu', 'ncurses', '6.3'), ('openssl', 'openssl', '1.1.1o'),
                      ('python\\-requests', 'requests', '2.28.1'), ('yaml_project', 'yaml', '0.2.5'),
                      ('openssl_project', 'openssl', '1.1.1o'), ('libcurl', 'libcurl', '7.83.1'),
                      ('pyopenssl_project', 'pyopenssl', '22.0.0'), ('urllib3', 'urllib3', '1.26.10'),
                      ('sun', 'nss', '3.77'), ('nghttp2', 'nghttp2', '1.47.0'), ('haxx', 'libcurl', '7.83.1'),
                      ('gnu', 'readline', '8.1.2'), ('jean\\-paul_calderone', 'pyopenssl', '22.0.0'),
                      ('numfocus', 'pandas', '1.4.2'), ('freebsd', 'libarchive', '3.5.2'),
                      ('curl', 'libcurl', '7.83.1'), ('keyutils_project', 'keyutils', '1.6.1'),
                      ('opensuse', 'libsolv', '0.7.22'), ('gnu', 'zlib', '1.2.12'), ('redhat', 'openssl', '1.1.1o'),
                      ('libarchive', 'libarchive', '3.5.2'), ('wordpress', 'requests', '2.28.1'),
                      ('ruamel\\.yaml_project', 'ruamel\\.yaml', '0.15.80'), ('sqlite', 'sqlite', '3.39.0'),
                      ('protobuf_project', 'protobuf', '3.20.1'), ('python', 'python', '3.8.13'),
                      ('python', 'urllib3', '1.26.10'), ('pyopenssl', 'pyopenssl', '22.0.0'),
                      ('xz_project', 'xz', '5.2.5'), ('zeromq', 'zeromq', '4.3.4'), ('python', 'setuptools', '63.1.0'),
                      ('golang', 'protobuf', '3.20.1'), ('python', 'requests', '2.28.1'), ('php\\-nuke', 'ev', '4.33'),
                      ('lapack_project', 'lapack', '3.9.0'), ('libssh2', 'libssh2', '1.10.0'),
                      ('ncurses_project', 'ncurses', '6.3'), ('tukaani', 'xz', '5.2.5'),
                      ('libedit_project', 'libedit', '3.1.20191231'), ('zlib', 'zlib', '1.2.12'),
                      ('cryptography_project', 'cryptography', '37.0.2'), ('google', 'protobuf', '3.20.1'),
                      ('cryptography\\.io', 'cryptography', '37.0.2'), ('lzo_project', 'lzo', '2.10'),
                      ('pip\\-installer', 'pip', '22.1.2'), ('xmlsoft', 'libxml2', '2.9.14'),
                      ('numpy', 'numpy', '1.22.3'), ('pypa', 'pip', '22.1.2')}
