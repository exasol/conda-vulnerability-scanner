import json
import sqlite3
from pathlib import Path

from conda_security_scanner.scanner import lookup_cpes_for_packages


def test_lookup_cpes_for_packages_cpe_found(test_package_list_path, test_sqlite_path):
    """
    This runs lookup_cpes_for_packages with a package list which contains a package which is in the test db
    """
    with open(test_package_list_path) as f:
        packages = json.load(f)
    con = sqlite3.connect(test_sqlite_path)
    result = lookup_cpes_for_packages(packages[:], con)
    assert result == {('google', 'tensorflow', '2.8.0'), ('tensorflow', 'tensorflow', '2.8.0')}


def test_lookup_cpes_for_packages_no_cpe_found(test_sqlite_path):
    """
    This runs lookup_cpes_for_packages with a package list which contains no package which is in the test db
    """
    packages = [{"name": "not_existing_package", "version": "2.2.0"}]
    con = sqlite3.connect(test_sqlite_path)
    result = lookup_cpes_for_packages(packages[:], con)
    assert result == set()
