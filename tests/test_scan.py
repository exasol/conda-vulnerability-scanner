import json
import tempfile
from pathlib import Path

from conda_security_scanner.scanner import scan_and_report


def test():
    script_directory = Path(__file__).parent
    with tempfile.TemporaryDirectory() as temp_dir:
        output_file = Path(temp_dir) / "report.json"
        scan_and_report(script_directory / "resources/test_db", output_file, script_directory / "resources/mamba_list.json")
        with output_file.open("r") as f:
            json_report = f.read()
    objs = sorted(json.loads(json_report), key=lambda d: str(d))
    expected = sorted([{"cve": "CVE-2022-2068", "cvss": "9.8", "cvss2": "10.0", "cvss3": "9.8", "cwe": "CWE-78",
                        "cpe": "cpe:/a:openssl:openssl:1.1.1o"},
                       {"cve": "CVE-2022-2097", "cvss": "7.5", "cvss2": "5.0", "cvss3": "7.5", "cwe": "CWE-326",
                        "cpe": "cpe:/a:openssl:openssl:1.1.1o"},
                       {"cve": "CVE-2022-29458", "cvss": "7.1", "cvss2": "5.8", "cvss3": "7.1", "cwe": "CWE-125",
                        "cpe": "cpe:/a:gnu:ncurses:6.3"}], key=lambda d: str(d))
    assert objs == expected
