import subprocess

from conda_security_scanner.scanner import ExitCode


def test_cli_scan(test_db_path, test_package_list_path, tmp_path):
    """
    This test runs the CLI in a subprocess and tests the scan command
    """
    json_report_file = tmp_path / "json-report.json"
    return_code = subprocess.call(["python", "-m", "conda_security_scanner.scanner", "scan",
                                   "--db-directory", test_db_path,
                                   "--package-list-file", test_package_list_path,
                                   "--json-report-file", json_report_file])

    assert return_code == ExitCode.CVE_FOUND.value and json_report_file.exists()


def test_cli_fetch(tmp_path):
    """
    This test runs the CLI in a subprocess and tests the fetch command
    """
    return_code = subprocess.call(["python", "-m", "conda_security_scanner.scanner", "fetch",
                                   "--db-directory", tmp_path])

    assert return_code == 0
