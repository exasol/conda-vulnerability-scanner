import datetime
import tempfile
from pathlib import Path

from conda_vulnerability_scanner.scanner import download_all_nvd_datafeed_files


def test_download_all_nvd_datafeed_files(tmp_path):
    """
    This tests runs download_all_nvd_datafeed_files and checks if all datafeed files are downloaded
    """
    files = download_all_nvd_datafeed_files(tmp_path)
    current_year = datetime.datetime.now().year
    expected_file_names = [f'nvdcve-1.1-{i}.json.gz' for i in range(2002, current_year + 1)]
    actual_file_names = sorted([file.name for file in tmp_path.glob("*")])
    sorted_files = sorted(files)
    sorted_glob = sorted(tmp_path.glob("*"))
    assert actual_file_names == expected_file_names and sorted_glob == sorted_files
