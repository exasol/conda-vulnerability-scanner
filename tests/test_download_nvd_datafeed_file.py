import json
import tempfile
from gzip import GzipFile
from pathlib import Path

from conda_security_scanner.scanner import download_nvd_datafeed_file


def test_download_nvd_datafeed_file(tmp_path):
    """
    This tests runs download_nvd_datafeed_file and checks if the downloaded file is valid gzipped json
    """
    link = '/feeds/json/cve/1.1/nvdcve-1.1-2022.json.gz'
    actual_file_path = download_nvd_datafeed_file(link, tmp_path)
    expected_file = tmp_path / "nvdcve-1.1-2022.json.gz"
    assert expected_file.is_file() and expected_file == actual_file_path
    content = GzipFile(expected_file).read()
    json_content = json.loads(content)
